<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - AWS Server Monitor</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <nav class="navbar">
    <div class="navbar-container">
      <a href="/admin/dashboard" class="navbar-brand">üõ°Ô∏è LeanHub Monitor</a>
      <ul class="navbar-menu">
        <li><a href="/admin/dashboard">Dashboard</a></li>
        <li><a href="/">View Site</a></li>
      </ul>
      <div class="navbar-actions">
        <a href="#" onclick="utils.logout()" class="btn btn-secondary btn-small">Logout</a>
      </div>
    </div>
  </nav>

  <main class="container" style="margin-top: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h1>Server Monitoring Dashboard</h1>
      <div id="aws-status">
        <span class="badge badge-secondary">Checking AWS Connection...</span>
      </div>
    </div>

    <!-- Metrics Cards -->
    <div class="grid grid-4" id="stat-cards">
      <div class="card stat-card">
        <div class="stat-value" id="cpu-avg">--%</div>
        <div class="stat-label">Avg CPU (Last Hour)</div>
      </div>
      <div class="card stat-card">
        <div class="stat-value" id="login-count">--</div>
        <div class="stat-label">Recent Logins</div>
      </div>
      <div class="card stat-card">
        <div class="stat-value" id="status-text">Healthy</div>
        <div class="stat-label">System Status</div>
      </div>
      <div class="card stat-card">
        <div class="stat-value" id="active-sessions">--</div>
        <div class="stat-label">Active Sessions</div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-2 mt-3">
      <div class="card">
        <h3 class="mb-2">Server Load (CPU Utilization)</h3>
        <canvas id="cpuChart" height="200"></canvas>
      </div>
      <div class="card">
        <h3 class="mb-2">Recent Login Activity</h3>
        <div id="login-logs" style="max-height: 300px; overflow-y: auto;">
          <p class="text-muted">Loading logs...</p>
        </div>
      </div>
    </div>

    <!-- Detailed Users Table -->
    <div class="mt-3">
      <h2 class="mb-2">System Users & Security</h2>
      <div class="card">
        <div id="users-table-container"></div>
      </div>
    </div>
  </main>

  <script src="/js/main.js"></script>
  <script>
    let cpuChart = null;

    async function checkAWSStatus() {
      try {
        const status = await utils.apiCall('/api/monitoring/status');
        const container = document.getElementById('aws-status');
        if (status.success) {
          container.innerHTML = `<span class="badge badge-primary">‚úÖ AWS Connected: ${status.identity.split(':').pop()}</span>`;
        } else {
          container.innerHTML = `<span class="badge badge-danger">‚ùå AWS Error: ${status.error}</span>`;
        }
      } catch (error) {
        console.error("Status check failed", error);
      }
    }

    async function loadStats() {
      try {
        const data = await utils.apiCall('/api/monitoring/stats');
        
        // Update Stats
        if (data.load && data.load.length > 0) {
          const avg = (data.load.reduce((sum, dp) => sum + dp.Average, 0) / data.load.length).toFixed(1);
          document.getElementById('cpu-avg').textContent = `${avg}%`;
          updateChart(data.load);
        }

        document.getElementById('login-count').textContent = data.localLogins.length;

        // Update Logs List
        const logsContainer = document.getElementById('login-logs');
        if (data.localLogins.length === 0) {
            logsContainer.innerHTML = '<p class="text-muted">No recent logins</p>';
        } else {
            logsContainer.innerHTML = data.localLogins.map(login => `
                <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between;">
                    <span><strong>${login.username}</strong></span>
                    <span class="text-muted" style="font-size: 0.8rem;">${new Date(login.last_login).toLocaleString()}</span>
                </div>
            `).join('');
        }

      } catch (error) {
        console.error("Stats load failed", error);
      }
    }

    function updateChart(datapoints) {
      const ctx = document.getElementById('cpuChart').getContext('2d');
      const labels = datapoints.map(dp => new Date(dp.Timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
      const values = datapoints.map(dp => dp.Average);

      if (cpuChart) {
        cpuChart.data.labels = labels;
        cpuChart.data.datasets[0].data = values;
        cpuChart.update();
      } else {
        cpuChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'CPU Utilization %',
              data: values,
              borderColor: '#0070f3',
              backgroundColor: 'rgba(0, 112, 243, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, max: 100 }
            }
          }
        });
      }
    }

    async function loadUsers() {
        try {
            const data = await utils.apiCall('/api/admin/users');
            const container = document.getElementById('users-table-container');
            
            container.innerHTML = `
                <table style="width: 100%;">
                    <thead>
                        <tr style="text-align: left; border-bottom: 2px solid var(--glass-border);">
                            <th style="padding: 1rem;">Username</th>
                            <th style="padding: 1rem;">Role</th>
                            <th style="padding: 1rem;">Last Login</th>
                            <th style="padding: 1rem;">Failed Attempts</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.users.map(u => `
                            <tr style="border-bottom: 1px solid var(--glass-border);">
                                <td style="padding: 1rem;">${u.username}</td>
                                <td style="padding: 1rem;"><span class="badge ${u.role === 'admin' ? 'badge-primary' : 'badge-secondary'}">${u.role}</span></td>
                                <td style="padding: 1rem;">${u.last_login ? new Date(u.last_login).toLocaleString() : 'Never'}</td>
                                <td style="padding: 1rem;">${u.failed_login_attempts}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } catch (e) {
            console.error(e);
        }
    }

    // Initial load
    checkAWSStatus();
    loadStats();
    loadUsers();

    // Refresh every 30 seconds
    setInterval(() => {
        loadStats();
    }, 30000);
  </script>
</body>

</html>
